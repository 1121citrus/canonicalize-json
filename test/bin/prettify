#!/usr/bin/env bash

TARGET_IMAGE="1121citrus/canonicalize-json:${TAG:-latest}"

setup() {
    return 0
}

# Shared test logic. Arguments: test_name, prettify_var (PRETTIFY or PRETTY_PRINT).
# Generates expected output by running local jq against the known canonical form,
# so the test covers any valid INDENT value (0-7) without hard-coded branches.
_run_prettify_test() {
    local test_name="${1}"
    local prettify_var="${2}"
    local indent=${INDENT:-2}
    local input expected output

    input=${TESTDATA:-'{"z":{"dec":"122","hex":"7A","oct":"172"},"1":{"hex":"31","oct":"61","dec":"49"},"A":{"hex":"41", "dec":"65","oct":"101"}}'}
    expected=$(jq --indent "${indent}" . <<< '{"1":{"dec":"49","hex":"31","oct":"61"},"A":{"dec":"65","hex":"41","oct":"101"},"z":{"dec":"122","hex":"7A","oct":"172"}}')

    if ! output=$(echo -n "${input}" | docker run -i --rm \
            -e DEBUG="${DEBUG:-false}" \
            -e "${prettify_var}=true" \
            -e INDENT="${indent}" \
            "${TARGET_IMAGE}"); then
        echo "FAIL '${test_name}': docker invocation failed" >/dev/stderr
        return 1
    fi

    if [[ "${output}" == "${expected}" ]]; then
        echo "PASS '${test_name}': prettified output matches expected (indent=${indent})"
    else
        echo "FAIL '${test_name}': expected '${expected}' but got '${output}'" >/dev/stderr
        return 1
    fi
}

test_prettify_json_output() {
    _run_prettify_test "${FUNCNAME[0]}" PRETTIFY
}

test_prettify_json_output_indent_4() {
    local INDENT=4
    _run_prettify_test "${FUNCNAME[0]}" PRETTIFY
}

test_pretty_print_alias() {
    _run_prettify_test "${FUNCNAME[0]}" PRETTY_PRINT
}

test_pretty_print_alias_indent_4() {
    local INDENT=4
    _run_prettify_test "${FUNCNAME[0]}" PRETTY_PRINT
}

run_tests() {
    local passed=0
    local tests=(
        test_prettify_json_output
        test_prettify_json_output_indent_4
        test_pretty_print_alias
        test_pretty_print_alias_indent_4
    )

    setup || { echo "ERROR: Setup failed"; return 1; }

    echo "Running tests for canonicalize-json prettify mode..."
    echo "===================================================="

    for testfile in "${tests[@]}"; do
        "${testfile}" && ((passed++)) || :
    done

    local failed=$((${#tests[@]} - passed))
    echo "===================================================="
    echo "Results: ${passed} passed, ${failed} failed"
    return "${failed}"
}

[[ "${BASH_SOURCE[0]}" == "$0" ]] && run_tests
